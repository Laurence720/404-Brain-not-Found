<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>InvestMate</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0f1115;
      --panel: #0f1217;
      --muted: #9aa3ae;
      --text: #e6e8eb;
      --brand: #1f2937;
      --brand-2: #2b313a;
      --ok: #16a34a;
      --err: #ef4444;
      --radius: 16px;
      --shadow-1: 0 12px 32px #00000066, 0 2px 8px #00000066;
      --border: #232833;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 800px at 80% -20%, #2a2f3a80, transparent 60%),
                  linear-gradient(140deg, #0b0e13 0%, #12161c 60%, #0b0e13 100%);
      background-size: 200% 200%, 100% 100%;
      animation: bg-pan 18s linear infinite;
    }
    /* Subtle grain */
    body::before { content: ""; position: fixed; inset: 0; pointer-events: none; z-index: 0;
      background-image: radial-gradient(#ffffff12 0.5px, transparent 0.5px);
      background-size: 2px 2px; opacity: .07; mix-blend-mode: soft-light; }

    .container { position: relative; max-width: 960px; margin: 0 auto; padding: 32px 24px 40px; z-index: 1; }
    header { display:flex; align-items:center; justify-content:space-between; margin-bottom: 20px; animation: fadeUp .6s both; }
    .title { font-weight: 800; letter-spacing: .2px; font-size: 26px; color: var(--text); }
    .badge { font-size: 13px; color: #e5e7eb; background: linear-gradient(120deg, #1c2027, #242a33, #1c2027);
             padding: 6px 14px; border-radius: 999px; border: 1px solid var(--border);
             background-size: 220% 100%; animation: shine 6s linear infinite; }

    .card { background: linear-gradient(180deg, #131821cc, #0f141bcc);
            border: 1px solid var(--border); border-radius: var(--radius);
            box-shadow: var(--shadow-1); overflow: hidden; backdrop-filter: blur(8px);
            transform-style: preserve-3d; will-change: transform, box-shadow;
            transition: transform .18s cubic-bezier(.2,.8,.2,1), box-shadow .3s ease; animation: floatIn .7s .05s both; }
    .card:hover { box-shadow: 0 18px 48px #00000088, 0 6px 18px #00000066; }

    .toolbar { display:flex; gap:8px; padding: 16px; border-bottom: 1px solid var(--border);
               background: linear-gradient(180deg, #0f141bcc, #0b0f16cc); align-items: center; }
    .toolbar .input { flex:1; display:flex; gap: 8px; background: #0b0f16; border: 1px solid #1b2230; border-radius: 12px; padding: 10px 12px; }
    textarea { flex:1; resize: vertical; min-height: 72px; max-height: 240px; border: none; outline: none; background: transparent; color: var(--text); font: inherit; }

    .btn {
      position: relative; overflow: hidden; display:inline-flex; align-items:center; gap:8px; padding: 10px 16px;
      border-radius: 12px; border: 1px solid #202633; background: #121821; color: #e5e7eb; cursor: pointer; font-weight: 700;
      transition: transform .06s ease, box-shadow .15s ease, background .2s ease, border-color .2s ease;
      user-select: none; box-shadow: 0 2px 10px #00000066 inset, 0 1px 0 #222a36;
    }
    .btn:hover { background: #171e28; box-shadow: 0 4px 14px #00000099; }
    .btn:active { transform: translateY(1px) scale(.99); }
    .btn.primary { background: linear-gradient(120deg, #0f1720, #1a2230, #0f1720); border-color: #263042; color: #f9fafb;
                   background-size: 220% 100%; animation: shine 8s linear infinite; }
    .btn.ghost { background: #0d131a; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .btn:focus-visible { outline: 2px solid #64748b; outline-offset: 2px; }
    .btn .ripple { position: absolute; left: 0; top: 0; width: 24px; height: 24px; border-radius: 999px;
                   background: radial-gradient(circle, #ffffff 0%, #ffffff 40%, #ffffff00 60%);
                   transform: translate(-50%, -50%) scale(0); opacity: .35; animation: ripple .7s ease-out forwards; pointer-events: none; filter: blur(.5px); }

    .status { font-size: 13px; color: var(--muted); margin-left: 12px; display:flex; align-items:center; gap:8px; }
    #status::before { content:""; width:8px; height:8px; border-radius:999px; background:#10b981; box-shadow: 0 0 0 0 #10b98166; display:inline-block; animation: pulse 1.8s infinite; }

    .chat { padding: 16px; display:flex; flex-direction: column; gap: 16px; max-height: calc(100vh - 280px); overflow: auto; background: #0b0f16; }
    .chat { -webkit-mask-image: linear-gradient(to bottom, transparent 0, rgba(0,0,0,.7) 24px, #000 48px, #000 calc(100% - 24px), transparent 100%);
             mask-image: linear-gradient(to bottom, transparent 0, rgba(0,0,0,.7) 24px, #000 48px, #000 calc(100% - 24px), transparent 100%);
    }

    .msg { display:flex; gap: 14px; align-items: flex-start; }
    .bubble { padding: 16px 18px; border-radius: 16px; border: 1px solid #1d2532; background: linear-gradient(180deg, #121824, #0f141c);
              max-width: 80%; white-space: pre-wrap; line-height: 1.75; box-shadow: 0 6px 22px #00000066; animation: bubbleIn .35s ease-out both; }
    .me .bubble { background: linear-gradient(180deg, #141b27, #101620); border-color: #263042; }
    .ai .bubble { background: linear-gradient(180deg, #10161f, #0d131a); border-color: #202636; }
    .role { font-size: 11px; font-weight: 700; letter-spacing: .12em; color: #93a0b3; margin-bottom: 8px; text-transform: uppercase; }

    .row { display:flex; gap: 8px; align-items:center; }
    .grow { flex:1; }

    footer { margin-top: 16px; color: var(--muted); font-size: 12px; display:flex; justify-content: space-between; align-items: center; gap: 8px; flex-wrap: wrap; }
    code.inline { background: #0f141c; border: 1px solid #1b2230; padding: 2px 6px; border-radius: 6px; color: #a9b2bd; }

    /* streaming toggle as a pill switch */
    #toggle-stream { position: relative; display:inline-flex; align-items:center; gap:8px; padding: 6px 36px 6px 14px; border-radius: 999px;
                     border: 1px solid #1b2230; background: #0e141c; color: #c5cbd4; text-decoration: none; transition: background .2s ease, border-color .2s ease; }
    #toggle-stream:hover { background:#141b25; border-color:#253042; }
    #toggle-stream::after { content:""; position: absolute; right: 8px; width: 16px; height: 16px; border-radius: 50%; background: #9ca3af; box-shadow: inset 0 0 0 2px #0b0f16; transition: transform .25s ease, background .25s ease; }
    #toggle-stream[data-on="true"]::after { transform: translateX(-18px); background: #16a34a; }

    .spinner { width: 16px; height: 16px; border: 2px solid #2c3440; border-top-color: transparent; border-radius: 50%; animation: spin .8s linear infinite; }

    /* Decorative, blurred floating orbs */
    .fx-orbs { position: fixed; inset: 0; pointer-events: none; z-index: 0; overflow: hidden; }
    .fx-orbs .orb { position: absolute; border-radius: 999px; filter: blur(60px); opacity: .12; background: radial-gradient(circle at 30% 30%, #ffffff, #a3aab4 60%, transparent 70%); }
    .fx-orbs .o1 { width: 420px; height: 420px; left: -120px; top: -80px; animation: float 16s ease-in-out infinite; }
    .fx-orbs .o2 { width: 360px; height: 360px; right: -140px; top: 20vh; animation: float 20s ease-in-out -3s infinite; }
    .fx-orbs .o3 { width: 520px; height: 520px; left: 10vw; bottom: -200px; animation: float 22s ease-in-out -6s infinite; }

    @media (max-width: 640px) { .bubble { max-width: 100%; } }

    /* Animations */
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes fadeUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: none; } }
    @keyframes floatIn { from { opacity: 0; transform: translateY(10px) scale(.98); } to { opacity: 1; transform: none; } }
    @keyframes bubbleIn { from { opacity: 0; transform: translateY(6px) scale(.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
    @keyframes shine { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    @keyframes bg-pan { 0% { background-position: 0% 0%; } 100% { background-position: 200% 0%; } }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 #10b98166; } 70% { box-shadow: 0 0 0 8px #10b98100; } 100% { box-shadow: 0 0 0 0 #10b98100; } }
    @keyframes float { 0%,100% { transform: translateY(0) translateX(0) scale(1); } 50% { transform: translateY(-14px) translateX(6px) scale(1.02); } }
    @keyframes ripple { to { transform: translate(-50%, -50%) scale(14); opacity: 0; } }

    /* --- Center the chat panel width & layout --- */
    header, footer, .card { max-width: 900px; width: 100%; margin-left: auto; margin-right: auto; }
    .container { display: grid; justify-items: center; align-content: start; min-height: 100dvh; gap: 12px; animation: pageRise .9s 1.1s cubic-bezier(.2,.8,.2,1) both; }
    .card { margin-top: 2vh; margin-bottom: 3vh; }

    /* --- Flashier page intro overlay --- */
    .intro { position: fixed; inset: 0; z-index: 999; display:flex; align-items:center; justify-content:center; background:
      radial-gradient(60% 60% at 50% 50%, #1a2230, #0b0f16 60%, #000 100%); overflow:hidden; }
    .intro .logo { font-weight: 900; font-size: clamp(32px, 7vw, 64px); letter-spacing: .12em; text-transform: uppercase;
      color: #e6e8eb; text-shadow: 0 0 24px #9fb2c533, 0 0 64px #9fb2c522; animation: logoPop .9s ease-out; }
    .intro .burst { position:absolute; width: 160vmax; height: 160vmax; background:
      conic-gradient(from 0deg, #ffffff10, #bcc6d520, #ffffff10 60%, transparent 80%); filter: blur(14px);
      animation: spin 2.6s linear infinite; opacity: .6; }
    .intro .beam { position:absolute; left:-20vw; right:-20vw; height:2px; background: linear-gradient(90deg, transparent, #ffffff66, transparent);
      filter: blur(1px); mix-blend-mode: screen; animation: sweep 1.3s ease-in-out .1s infinite; }
    .intro .beam.b2 { animation-delay: .4s; opacity:.6; }
    .intro .ring { position:absolute; width: 20vmin; height: 20vmin; border: 2px solid #aab2be44; border-radius: 999px;
      animation: ringExpand 1.2s cubic-bezier(.2,.8,.2,1) .2s forwards; }
    .intro .ring.r2 { animation-delay: .45s; opacity: .7; }

    .intro.hide { animation: introFade 1.1s ease forwards; }

    /* Page rise (content reveal) */
    @keyframes pageRise { from { opacity: 0; transform: translateY(16px) scale(.98); filter: blur(4px); }
      to { opacity: 1; transform: none; filter: none; } }

    /* Intro sequences */
    @keyframes logoPop { 0% { transform: translateY(14px) scale(.92); opacity: 0; }
      60% { transform: translateY(-4px) scale(1.04); opacity: 1; }
      100% { transform: none; } }
    @keyframes introFade { to { opacity: 0; visibility: hidden; } }
    @keyframes sweep { 0% { transform: translateY(-40vh); opacity: 0; } 50% { opacity: 1; } 100% { transform: translateY(40vh); opacity: 0; } }
    @keyframes ringExpand { from { transform: scale(.2); opacity: .9; } to { transform: scale(12); opacity: 0; } }
  </style>
</head>
<body>
  <!-- Intro overlay -->
  <div id="intro" class="intro" aria-hidden="true">
    <div class="burst"></div>
    <div class="beam"></div>
    <div class="beam b2"></div>
    <span class="ring r1"></span>
    <span class="ring r2"></span>
    <div class="logo">InvestMate</div>
  </div>

  <div class="fx-orbs" aria-hidden="true">
    <span class="orb o1"></span>
    <span class="orb o2"></span>
    <span class="orb o3"></span>
  </div>

  <div class="container">
    <header>
      <div class="row">
        <div class="badge">InvestMate</div>
        <div class="status" id="status">InvestMate is ready · ask away</div>
      </div>
      <div class="title">InvestMate · Your Wealth Copilot</div>
    </header>

    <section class="card" role="region" aria-label="Chat Panel">
      <div class="toolbar">
        <div class="input">
          <textarea id="prompt" placeholder="Ask InvestMate anything. Press Ctrl/⌘ + Enter to send…"></textarea>
        </div>
        <button id="send" class="btn primary" title="Send (Ctrl/⌘+Enter)">Send</button>
        <button id="clear" class="btn ghost" title="Clear conversation">Clear</button>
      </div>
      <div id="chat" class="chat" aria-live="polite"></div>
    </section>

    <footer>
      <div>Endpoint <code class="inline">POST /api/chat</code> returns <code class="inline">{ output: string }</code>.</div>
      <div><a href="#" id="toggle-stream" data-on="false" role="switch" aria-checked="false">Streaming: Off</a></div>
    </footer>
  </div>

  <script>
    // =================== Configuration (tweak as needed) ===================
    const API_URL = `${window.location.origin}/api/chat`;
    let STREAMING = false;                // Enable streaming if the backend supports SSE / fetch streams

    // =================== Lightweight state & DOM helpers ===================
    const chatEl = document.getElementById('chat');
    const promptEl = document.getElementById('prompt');
    const sendBtn = document.getElementById('send');
    const clearBtn = document.getElementById('clear');
    const statusEl = document.getElementById('status');
    const toggleStream = document.getElementById('toggle-stream');

    const cardEl = document.querySelector('.card');

    // Button ripple effect
    function createRipple(e) {
      const btn = e.currentTarget;
      const rect = btn.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      const rip = document.createElement('span');
      rip.className = 'ripple';
      rip.style.left = x + 'px';
      rip.style.top = y + 'px';
      btn.appendChild(rip);
      rip.addEventListener('animationend', () => rip.remove());
    }
    // Attach ripple to all buttons
    document.querySelectorAll('.btn').forEach(b => b.addEventListener('click', createRipple));

    // 3D tilt on the main card
    if (cardEl) {
      const resetTilt = () => { cardEl.style.transform = ''; };
      cardEl.addEventListener('mousemove', (e) => {
        const r = cardEl.getBoundingClientRect();
        const cx = r.left + r.width / 2;
        const cy = r.top + r.height / 2;
        const dx = (e.clientX - cx) / r.width;  // -0.5 .. 0.5
        const dy = (e.clientY - cy) / r.height; // -0.5 .. 0.5
        const rx = (dy) * 6;   // rotateX
        const ry = -(dx) * 8;  // rotateY
        cardEl.style.transform = `perspective(1000px) rotateX(${rx}deg) rotateY(${ry}deg) translateZ(6px)`;
      });
      cardEl.addEventListener('mouseleave', resetTilt);
    }

    const state = { messages: [] };

    function appendMessage(role, content) {
      const wrap = document.createElement('div');
      wrap.className = `msg ${role}`;

      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.classList.add('pop');

      const roleEl = document.createElement('div');
      roleEl.className = 'role';
      roleEl.textContent = role === 'me' ? 'You' : 'InvestMate';

      const contentEl = document.createElement('div');
      contentEl.textContent = content;

      bubble.appendChild(roleEl);
      bubble.appendChild(contentEl);
      wrap.appendChild(bubble);
      chatEl.appendChild(wrap);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function setLoading(loading) {
      sendBtn.disabled = loading;
      statusEl.innerHTML = loading ? '<span class="row"><span class="spinner"></span> InvestMate is thinking…</span>' : 'InvestMate is ready · ask away';
    }

    async function sendNonStreaming(payload) {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      return data.output ?? '';
    }

    async function sendStreaming(payload) {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'text/event-stream' },
        body: JSON.stringify({ ...payload, stream: true }),
      });
      if (!res.ok || !res.body) throw new Error(`HTTP ${res.status}`);

      const reader = res.body.getReader();
      const decoder = new TextDecoder();

      // Pre-populate the chat with an empty assistant bubble
      const wrap = document.createElement('div');
      wrap.className = 'msg ai';
      const bubble = document.createElement('div');
      bubble.className = 'bubble pop';
      const roleEl = document.createElement('div');
      roleEl.className = 'role';
      roleEl.textContent = 'InvestMate';
      const contentEl = document.createElement('div');
      contentEl.textContent = '';
      bubble.appendChild(roleEl);
      bubble.appendChild(contentEl);
      wrap.appendChild(bubble);
      chatEl.appendChild(wrap);

      let buffer = '';
      let fullText = '';
      while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, { stream: true });

        // Parse SSE payloads split by blank lines, with each line prefixed by `data:`
        const events = buffer.split("\n\n");
        buffer = events.pop() || "";
        for (const evt of events) {
          const lines = evt.split("\n");
          for (const line of lines) {
            if (line.startsWith("data:")) {
              const text = line.slice(5).trimStart();
              contentEl.textContent += text;
              fullText += text;
              chatEl.scrollTop = chatEl.scrollHeight;
            }
          }
        }
      }
      return fullText || contentEl.textContent;
    }

    async function handleSend() {
      const content = promptEl.value.trim();
      if (!content) return;

      appendMessage('me', content);
      promptEl.value = '';
      setLoading(true);

      const payload = { input: content, history: state.messages };
      try {
        if (STREAMING) {
          const output = await sendStreaming(payload);
          state.messages.push({ role: 'user', content });
          state.messages.push({ role: 'assistant', content: output });
        } else {
          const output = await sendNonStreaming(payload);
          appendMessage('ai', output);
          state.messages.push({ role: 'user', content });
          state.messages.push({ role: 'assistant', content: output });
        }
      } catch (err) {
        console.error(err);
        appendMessage('ai', `Error: ${err.message}`);
      } finally {
        setLoading(false);
      }
    }

    sendBtn.addEventListener('click', handleSend);
    promptEl.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        handleSend();
      }
    });

    clearBtn.addEventListener('click', () => {
      state.messages = [];
      chatEl.innerHTML = '';
      statusEl.textContent = 'InvestMate is ready · ask away';
      promptEl.value = '';
      promptEl.focus();
    });

    toggleStream.addEventListener('click', (e) => {
      e.preventDefault();
      STREAMING = !STREAMING;
      toggleStream.textContent = STREAMING ? 'Streaming: On' : 'Streaming: Off';
      toggleStream.dataset.on = String(STREAMING);
      toggleStream.setAttribute('aria-checked', STREAMING ? 'true' : 'false');
    });

    // Page intro: let it play, then fade out & remove
    window.addEventListener('load', () => {
      const intro = document.getElementById('intro');
      if (!intro) return;
      setTimeout(() => {
        intro.classList.add('hide');
        setTimeout(() => intro.remove(), 1200); // match .intro.hide duration
      }, 900); // show overlay briefly before fading
    });
  </script>
</body>
</html>